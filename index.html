<!DOCTYPE html>
<html>
<head>
    <title>My VLSI Tool</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
       .container { display: flex; gap: 20px; }
       .left-panel,.right-panel { flex: 1; border: 1px solid #ccc; padding: 15px; }
       .section { margin-bottom: 20px; }
        textarea { width: 100%; box-sizing: border-box; height: 200px; margin-bottom: 10px; font-family: monospace; }
        button { margin-right: 10px; padding: 8px 15px; }
        #terminal-output-container { background-color: black; color: white; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; }
        #layout-viewer { border: 1px solid #ccc; background-color: #f0f0f0; height: 400px; width: 100%; }
        #designCanvas { display: block; background-color: white; }
    </style>
</head>
<body>
    <h1>My VLSI Tool for Students</h1>

    <div class="container">
        <div class="left-panel">
            <div class="section">
                <h2>1. Upload Your Design (Verilog RTL)</h2>
                <input type="file" id="rtlFileInput" accept=".v,.sv">
                <p>Or type your Verilog code here:</p>
                <textarea id="rtlCodeInput" placeholder="module my_design(input A, B, output Y);
    assign Y = A & B;
endmodule">module my_design(input A, B, output Y);
    assign Y = A & B;
endmodule</textarea>
            </div>

            <div class="section">
                <h2>2. Synthesis Flow</h2>
                <button id="runSynthesisBtn">Run Full Synthesis</button>
                <p>This will run the complete flow: Elaborate, Synthesize, Map to ASAP7, and Optimize.</p>
                <p>You can download your netlist here later: <span id="netlistDownloadLink"></span></p>
            </div>

            <div class="section">
                <h2>3. Physical Design Steps</h2>
                <button id="placeBtn">Place Cells</button>
                <button id="routeBtn">Route Wires</button>
                <p>You can download your DEF file here later: <span id="defDownloadLink"></span></p>
            </div>
        </div>

        <div class="right-panel">
            <div class="section">
                <h2>Design Visualization</h2>
                <div id="layout-viewer">
                    <canvas id="designCanvas" width="780" height="380" style="border:1px solid #000;"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>Terminal Output</h2>
                <div id="terminal-output-container">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@yowasp/yosys/gen/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>

    <script>
        // --- DOM Element References ---
        const terminalContainer = document.getElementById('terminal-output-container');
        const rtlFileInput = document.getElementById('rtlFileInput');
        const rtlCodeInput = document.getElementById('rtlCodeInput');
        const runSynthesisBtn = document.getElementById('runSynthesisBtn');
        const placeBtn = document.getElementById('placeBtn');
        const routeBtn = document.getElementById('routeBtn');
        const netlistDownloadLink = document.getElementById('netlistDownloadLink');
        const designCanvas = document.getElementById('designCanvas');
        const ctx = designCanvas.getContext('2d');

        // --- Global State Variables ---
        let yosysModule; // This will hold the initialized Yosys WASM module.
        let currentNetlist = null; // Stores the parsed JSON netlist after successful synthesis.
        let placedCells = {}; // Stores the coordinates and dimensions of cells after placement.
        const allButtons = Array.from(document.querySelectorAll('button')); // Collect all buttons to enable/disable them.

        /**
         * Enables or disables all buttons and input fields on the page.
         * This is used to prevent user interaction while a long process is running.
         * @param {boolean} enabled - True to enable controls, false to disable.
         */
        function setControlsEnabled(enabled) {
            allButtons.forEach(button => button.disabled =!enabled);
            rtlFileInput.disabled =!enabled;
            rtlCodeInput.disabled =!enabled;
        }

        // --- Terminal Setup (using xterm.js) ---
        const term = new Terminal({
            cursorBlink: true,
            convertEol: true,
            rows: 15
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(terminalContainer);
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        // --- Yosys WASM Initialization ---

        // The Module object is a special object that Emscripten (the WASM compiler)
        // looks for. We configure it to redirect Yosys's stdout and stderr
        // to our xterm.js terminal instance.
        var Module = {
            print: (text) => { term.write(text + '\r\n'); },
            printErr: (text) => { term.write('\x1b; // Correctly get the first file
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    rtlCodeInput.value = e.target.result;
                };
                reader.readAsText(file);
            }
        });

        // Handle the main "Run Full Synthesis" button click
        runSynthesisBtn.addEventListener('click', async () => {
            const verilogCode = rtlCodeInput.value;
            if (!verilogCode.trim()) {
                Module.printErr('Error: Verilog code input is empty.');
                return;
            }

            setControlsEnabled(false);
            term.clear();
            term.write('--- Starting Full Synthesis Flow ---\r\n');
            currentNetlist = null; // Clear previous results
            placedCells = {};
            ctx.clearRect(0, 0, designCanvas.width, designCanvas.height);
            netlistDownloadLink.innerHTML = '';

            try {
                // Step 1: Fetch the technology library file (ASAP7) from GitHub.
                const libertyURL = 'https://raw.githubusercontent.com/Centre-for-Hardware-Security/asap7_reference_design/main/lib/asap7sc7p5t_24_R_TT_1p00V_25C.lib';
                term.write(`1. Fetching technology library from ${libertyURL}...\r\n`);
                const response = await fetch(libertyURL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const libertyFileContent = await response.text();
                term.write('  ... Library fetched successfully.\r\n');

                // Step 2: Write input files to Yosys's virtual filesystem.
                term.write('2. Preparing virtual filesystem...\r\n');
                yosysModule.FS.writeFile('/input.v', verilogCode);
                yosysModule.FS.writeFile('/asap7.lib', libertyFileContent);
                term.write('  ... Virtual files created.\r\n');

                // Step 3: Define the complete, multi-step Yosys synthesis script.
                // This single script is executed in one atomic Yosys run.
                const synthesisScript =.join('; ');

                // Step 4: Execute the synthesis script.
                term.write('3. Running Yosys Synthesis Script...\r\n');
                term.write('----------------------------------------\r\n');
                await yosysModule.callMain();
                term.write('----------------------------------------\r\n');
                term.write('\x1b;
                const cells = currentNetlist.modules[moduleName].cells;

                // --- Simple Random Placement Algorithm (for demonstration) ---
                const cellWidth = 60;
                const cellHeight = 40;
                const padding = 10;

                for (const cellName in cells) {
                    const x = padding + Math.random() * (designCanvas.width - cellWidth - 2 * padding);
                    const y = padding + Math.random() * (designCanvas.height - cellHeight - 2 * padding);
                    
                    const cellInfo = { x, y, width: cellWidth, height: cellHeight };
                    placedCells[cellName] = cellInfo;
                    
                    drawCell(cellName, cellInfo);
                }
                term.write('Placement complete. Cells are randomly placed on the canvas.\r\n');
            } catch (error) {
                Module.printErr(`Placement Failed: ${error}`);
            } finally {
                setControlsEnabled(true);
            }
        });

        // Handle "Route Wires" button click
        routeBtn.addEventListener('click', () => {
            if (!currentNetlist |

| Object.keys(placedCells).length === 0) {
                Module.printErr('Error: Must run synthesis and placement first.');
                return;
            }
            term.write('\n--- Running Routing ---\r\n');
            setControlsEnabled(false);

            try {
                // Redraw canvas with cells on top
                ctx.clearRect(0, 0, designCanvas.width, designCanvas.height);

                // --- Simple "Star" Routing Algorithm (for demonstration) ---
                const wireToCells = buildWireMap();
                drawRoutes(wireToCells);

                // Redraw cells so they appear on top of the routes
                for (const cellName in placedCells) {
                    drawCell(cellName, placedCells[cellName]);
                }
                term.write('Routing complete. Connections are drawn on the canvas.\r\n');

            } catch (error) {
                Module.printErr(`Routing Failed: ${error}`);
            } finally {
                setControlsEnabled(true);
            }
        });


        // --- Helper and Drawing Functions ---

        /**
         * Draws a single cell on the canvas.
         * @param {string} name - The name of the cell.
         * @param {object} info - An object with x, y, width, height properties.
         */
        function drawCell(name, info) {
            ctx.fillStyle = 'lightblue';
            ctx.fillRect(info.x, info.y, info.width, info.height);
            ctx.strokeStyle = 'darkblue';
            ctx.strokeRect(info.x, info.y, info.width, info.height);

            ctx.fillStyle = 'black';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name, info.x + info.width / 2, info.y + info.height / 2);
        }

        /**
         * Parses the netlist to create a map of wire IDs to the cells they connect.
         * @returns {object} An object where keys are wire IDs and values are Sets of cell names.
         */
        function buildWireMap() {
            const wireMap = {};
            const moduleName = Object.keys(currentNetlist.modules);
            const cellsInNetlist = currentNetlist.modules[moduleName].cells;

            for (const cellName in cellsInNetlist) {
                const cellData = cellsInNetlist[cellName];
                for (const portName in cellData.connections) {
                    const wireIds = cellData.connections[portName];
                    for (const wireId of wireIds) {
                        if (!wireMap[wireId]) {
                            wireMap[wireId] = new Set();
                        }
                        // Only add if the cell has been placed (i.e., it's not a pseudo-cell)
                        if (placedCells[cellName]) {
                           wireMap[wireId].add(cellName);
                        }
                    }
                }
            }
            return wireMap;
        }

        /**
         * Draws the routes (wires) on the canvas based on the wire map.
         * @param {object} wireToCells - The map of wires to connected cells.
         */
        function drawRoutes(wireToCells) {
            ctx.strokeStyle = 'rgba(0, 128, 0, 0.7)'; // Semi-transparent green
            ctx.lineWidth = 1;

            for (const wireId in wireToCells) {
                const connectedCellNames = Array.from(wireToCells[wireId]);
                if (connectedCellNames.length > 1) {
                    // Simple star routing: connect all pins on a net to the first pin.
                    const firstCellName = connectedCellNames;
                    const firstCell = placedCells[firstCellName];
                    const startX = firstCell.x + firstCell.width / 2;
                    const startY = firstCell.y + firstCell.height / 2;

                    for (let i = 1; i < connectedCellNames.length; i++) {
                        const otherCellName = connectedCellNames[i];
                        const otherCell = placedCells[otherCellName];
                        const endX = otherCell.x + otherCell.width / 2;
                        const endY = otherCell.y + otherCell.height / 2;

                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                    }
                }
            }
        }

        /**
         * Creates a downloadable link for a file.
         * @param {string} content - The text content of the file.
         * @param {string} fileName - The name for the downloaded file.
         * @param {string} mimeType - The MIME type of the file.
         * @param {HTMLElement} linkElement - The span element to place the link in.
         */
        function createDownloadLink(content, fileName, mimeType, linkElement) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.textContent = fileName;
            linkElement.innerHTML = ''; // Clear previous link
            linkElement.appendChild(a);
        }

        // --- Initial Application Load ---
        loadYosys();

    </script>
</body>
</html>

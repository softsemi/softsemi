<!DOCTYPE html>
<html>
<head>
    <title>My VLSI Tool</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
   .container { display: flex; gap: 20px; }
   .left-panel,.right-panel { flex: 1; border: 1px solid #ccc; padding: 15px; }
   .section { margin-bottom: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; }
        button { margin-right: 10px; padding: 8px 15px; }
        #terminal-output { background-color: black; color: white; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; }
        #layout-viewer { border: 1px solid #ccc; background-color: #f0f0f0; height: 400px; width: 100%; }
        #designCanvas { display: block; background-color: white; }
    </style>
</head>
<body>
    <h1>My VLSI Tool for Students</h1>

    <div class="container">
        <div class="left-panel">
            <div class="section">
                <h2>1. Upload Your Design (Verilog RTL)</h2>
                <input type="file" id="rtlFileInput" accept=".v,.sv">
                <p>Or type your Verilog code here:</p>
                <textarea id="rtlCodeInput" placeholder="module my_design(...);... endmodule;"></textarea>
            </div>

            <div class="section">
                <h2>2. Synthesis Steps</h2>
                <button id="elaborateBtn">Elaborate</button>
                <button id="synGenBtn">Synthesize Generic</button>
                <button id="synMapBtn">Synthesize Map</button>
                <button id="synOptBtn">Synthesize Optimize</button>
                <button id="generateNetlistBtn">Generate Gate-Level Netlist</button>
                <p>You can download your netlist here later.</p>
            </div>

            <div class="section">
                <h2>3. Physical Design Steps</h2>
                <button id="placeBtn">Place Cells</button>
                <button id="ctsBtn">Clock Tree Synthesis</button>
                <button id="routeBtn">Route Wires</button>
                <p>You can download your DEF file here later.</p>
            </div>
        </div>

        <div class="right-panel">
            <div class="section">
                <h2>Design Visualization</h2>
                <div id="layout-viewer">
                    <canvas id="designCanvas" width="780" height="380" style="border:1px solid #000;"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>Terminal Output</h2>
                <div id="terminal-output">
                    Welcome to the VLSI Terminal!
                    <br>Type 'help' for commands.
                    <br>>
                </div>
                <input type="text" id="terminal-input" style="width: calc(100% - 10px); margin-top: 5px;">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@yowasp/yosys/gen/bundle.js"></script>
    <script src="https://unpkg.com/@xterm/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/@xterm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script>
        const terminalElement = document.getElementById('terminal-output');
        const terminalInput = document.getElementById('terminal-input');
        const rtlFileInput = document.getElementById('rtlFileInput');
        const rtlCodeInput = document.getElementById('rtlCodeInput');
        const elaborateBtn = document.getElementById('elaborateBtn');
        const synGenBtn = document.getElementById('synGenBtn');
        const synMapBtn = document.getElementById('synMapBtn');
        const synOptBtn = document.getElementById('synOptBtn');
        const generateNetlistBtn = document.getElementById('generateNetlistBtn');
        const placeBtn = document.getElementById('placeBtn');
        const ctsBtn = document.getElementById('ctsBtn');
        const routeBtn = document.getElementById('routeBtn');

        const designCanvas = document.getElementById('designCanvas');
        const ctx = designCanvas.getContext('2d');

        const allButtons =;

        function setButtonsEnabled(enabled) {
            allButtons.forEach(button => {
                button.disabled =!enabled;
            });
            rtlFileInput.disabled =!enabled;
            rtlCodeInput.disabled =!enabled;
        }

        // Disable buttons initially
        setButtonsEnabled(false);

        const term = new Terminal({
            cursorBlink: true,
            convertEol: true
        });
        const fitAddon = new FitAddon.FitAddon();

        term.loadAddon(fitAddon);
        term.open(terminalElement);
        fitAddon.fit();

        term.onData(e => {
            // This sends data from the terminal to our input box
            terminalInput.value += e;
        });

        terminalInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                const command = terminalInput.value.trim();
                term.write('\r\n> ' + command + '\r\n'); // Echo command
                terminalInput.value = ''; // Clear input box

                // Handle simple commands for now
                if (command === 'help') {
                    term.write('Available commands: help, ls, cd, pwd\r\n');
                } else if (command === 'ls') {
                    term.write('index.html\r\ntech_files/\r\n');
                } else if (command === 'pwd') {
                    term.write('/\r\n');
                } else {
                    term.write('Unknown command: ' + command + '\r\n');
                }
                term.write('>');
            } else if (e.key === 'Backspace') {
                // Handle backspace in the input field
                if (terminalInput.value.length > 0) {
                    terminalInput.value = terminalInput.value.slice(0, -1);
                }
            }
        });

        // Make terminal responsive to window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        // Initial prompt
        term.write('>');

        let yosysModule; // This will hold our Yosys tool

        // This special code helps Yosys talk to our terminal
        var Module = {
            print: function(text) { term.write(text + '\r\n'); },
            printErr: function(text) { term.write(text + '\r\n'); },
            // This is needed for Yosys to work with files
            FS: null
        };

        async function loadYosys() {
            term.write('Loading VLSI brain... (this might take a moment)\r\n');
            yosysModule = await runYosys(Module);
            term.write('VLSI brain loaded! Type "help" in the terminal.\r\n>');
            setButtonsEnabled(true); // Enable buttons after Yosys is loaded
        }

        loadYosys(); // Start loading Yosys when the page opens

        // Dummy 45nm Liberty file content (simplified for demonstration)
        const dummyLibertyFileContent = `library (gscl45nm) {
delay_model : table_lookup;
time_unit : "1ns";
voltage_unit : "1V";
current_unit : "1mA";
capacitive_load_unit (1, pf);
leakage_power_unit : "1nW";
pulling_resistance_unit : "1kohm";
cell (AND2X1) {
area : 1.0;
pin (A1) { direction : input; }
pin (A2) { direction : input; }
pin (Z) { direction : output; function : "A1 * A2"; }
}
cell (INVX1) {
area : 0.5;
pin (I) { direction : input; }
pin (Z) { direction : output; function : "I'"; }
}
}
`;

        // Handle file input
        rtlFileInput.addEventListener('change', (event) => {
            const file = event.target.files;
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    rtlCodeInput.value = e.target.result;
                };
                reader.readAsText(file);
            }
        });

        // Handle Elaborate button click
        elaborateBtn.addEventListener('click', async () => {
            setButtonsEnabled(false); // Disable buttons during operation
            term.write('\r\nRunning Elaborate...\r\n');
            try {
                const verilogCode = rtlCodeInput.value;
                if (!verilogCode.trim()) {
                    term.write('Please provide Verilog code in the text area or by uploading a file.\r\n>');
                    return;
                }

                // Write Verilog code to the virtual file system
                yosysModule.FS.writeFile('/input.v', verilogCode);

                // Run Yosys command for elaboration
                // We assume the top module is named 'my_design' as per the placeholder
                await yosysModule.callMain(['-p', 'read_verilog input.v; hierarchy -top my_design', '-o', '/dev/stdout']);

                term.write('\r\nElaboration complete. You can now proceed with other synthesis steps.\r\n>');
            } catch (error) {
                term.write(`\r\nError during elaboration: ${error}\r\n>`);
            } finally {
                setButtonsEnabled(true); // Re-enable buttons
            }
        });

        // Handle Synthesize Generic button click
        synGenBtn.addEventListener('click', async () => {
            setButtonsEnabled(false); // Disable buttons during operation
            term.write('\r\nRunning Synthesize Generic...\r\n');
            try {
                // Run Yosys command for generic synthesis
                await yosysModule.callMain(['-p', 'synth -top my_design', '-o', '/dev/stdout']);

                term.write('\r\nGeneric Synthesis complete. You can now proceed with other synthesis steps.\r\n>');
            } catch (error) {
                term.write(`\r\nError during generic synthesis: ${error}\r\n>`);
            } finally {
                setButtonsEnabled(true); // Re-enable buttons
            }
        });

        // Handle Synthesize Map button click
        synMapBtn.addEventListener('click', async () => {
            setButtonsEnabled(false); // Disable buttons during operation
            term.write('\r\nRunning Synthesize Map...\r\n');
            try {
                // Ensure tech_files directory exists
                yosysModule.FS.mkdir('/tech_files'); [1, 2]
                // Write dummy Liberty file to the virtual file system
                yosysModule.FS.writeFile('/tech_files/gscl45nm.lib', dummyLibertyFileContent);

                // Run Yosys command for technology mapping
                await yosysModule.callMain(['-p', 'read_liberty -lib /tech_files/gscl45nm.lib; techmap; abc -liberty /tech_files/gscl45nm.lib', '-o', '/dev/stdout']);

                term.write('\r\nTechnology Mapping complete. You can now proceed with optimization or netlist generation.\r\n>');
            } catch (error) {
                term.write(`\r\nError during technology mapping: ${error}\r\n>`);
            } finally {
                setButtonsEnabled(true); // Re-enable buttons
            }
        });

        // Handle Synthesize Optimize button click
        synOptBtn.addEventListener('click', async () => {
            setButtonsEnabled(false); // Disable buttons during operation
            term.write('\r\nRunning Synthesize Optimize...\r\n');
            try {
                // Run Yosys command for optimization
                await yosysModule.callMain(['-p', 'opt', '-o', '/dev/stdout']);

                term.write('\r\nOptimization complete. You can now generate the netlist.\r\n>');
            } catch (error) {
                term.write(`\r\nError during optimization: ${error}\r\n>`);
            } finally {
                setButtonsEnabled(true); // Re-enable buttons
            }
        });

        // Handle Generate Gate-Level Netlist button click
        generateNetlistBtn.addEventListener('click', async () => {
            setButtonsEnabled(false); // Disable buttons during operation
            term.write('\r\nGenerating Gate-Level Netlist...\r\n');
            try {
                // Write the netlist to a JSON file in the virtual file system
                await yosysModule.callMain(['-p', 'write_json /output.json', '-o', '/dev/stdout']); [3, 4, 5, 6, 7]

                // Read the generated JSON file content
                const netlistJson = yosysModule.FS.readFile('/output.json', { encoding: 'utf8' });

                // Create a Blob from the JSON string
                const blob = new Blob([netlistJson], { type: 'application/json' }); [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
                const url = URL.createObjectURL(blob); [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]

                // Create a temporary link and trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gate_level_netlist.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]

                term.write('\r\nGate-Level Netlist generated and downloaded as gate_level_netlist.json\r\n>');
            } catch (error) {
                term.write(`\r\nError generating netlist: ${error}\r\n>`);
            } finally {
                setButtonsEnabled(true); // Re-enable buttons
            }
        });

        // Handle Place Cells button click
        placeBtn.addEventListener('click', async () => {
            setButtonsEnabled(false); // Disable buttons during operation
            term.write('\r\nRunning Place Cells...\r\n');
            try {
                // Clear previous drawing
                ctx.clearRect(0, 0, designCanvas.width, designCanvas.height);

                // Read the netlist JSON (assuming it was generated in the previous step)
                const netlistJson = yosysModule.FS.readFile('/output.json', { encoding: 'utf8' });
                const netlist = JSON.parse(netlistJson); [20, 21]

                const moduleName = Object.keys(netlist.modules); // Get the first module
                const cells = netlist.modules[moduleName].cells; [3, 22]

                const cellPositions = {};
                const cellWidth = 50; // Fixed width for visualization
                const cellHeight = 30; // Fixed height for visualization

                // Simple random placement
                for (const cellName in cells) {
                    const x = Math.random() * (designCanvas.width - cellWidth);
                    const y = Math.random() * (designCanvas.height - cellHeight);
                    cellPositions[cellName] = { x, y };

                    // Draw cell as a rectangle
                    ctx.fillStyle = 'lightblue';
                    ctx.fillRect(x, y, cellWidth, cellHeight); [23, 24, 25, 26, 27, 28]
                    ctx.strokeStyle = 'black';
                    ctx.strokeRect(x, y, cellWidth, cellHeight); [23, 24, 25, 26, 27, 28]
                    
                    // Add cell name text
                    ctx.fillStyle = 'black';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(cellName, x + cellWidth / 2, y + cellHeight / 2);
                }

                term.write('\r\nCells placed. You can now proceed with Clock Tree Synthesis or Routing.\r\n>');
            } catch (error) {
                term.write(`\r\nError during placement: ${error}\r\n>`);
            } finally {
                setButtonsEnabled(true); // Re-enable buttons
            }
        });
    </script>
</body>
</html>
```

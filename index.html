<!DOCTYPE html>
<html>
<head>
    <title>My VLSI Tool</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
       .container { display: flex; gap: 20px; }
       .left-panel,.right-panel { flex: 1; border: 1px solid #ccc; padding: 15px; }
       .section { margin-bottom: 20px; }
        textarea { width: 100%; box-sizing: border-box; height: 200px; margin-bottom: 10px; font-family: monospace; }
        button { margin-right: 10px; padding: 8px 15px; }
        #terminal-output-container { background-color: black; color: white; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; }
        #layout-viewer { border: 1px solid #ccc; background-color: #f0f0f0; height: 400px; width: 100%; }
        #designCanvas { display: block; background-color: white; }
    </style>
</head>
<body>
    <h1>My VLSI Tool for Students</h1>

    <div class="container">
        <div class="left-panel">
            <div class="section">
                <h2>1. Upload Your Design (Verilog RTL)</h2>
                <input type="file" id="rtlFileInput" accept=".v,.sv">
                <p>Or type your Verilog code here:</p>
                <textarea id="rtlCodeInput" placeholder="module my_design(input A, B, output Y);&#10;    assign Y = A & B;&#10;endmodule">module my_design(input A, B, output Y);
    assign Y = A & B;
endmodule</textarea>
            </div>

            <div class="section">
                <h2>2. Synthesis Flow</h2>
                <button id="runSynthesisBtn">Run Full Synthesis</button>
                <p>This will run the complete flow: Elaborate, Synthesize, Map to ASAP7, and Optimize.</p>
                <p>You can download your netlist here later: <span id="netlistDownloadLink"></span></p>
            </div>

            <div class="section">
                <h2>3. Physical Design Steps</h2>
                <button id="placeBtn">Place Cells</button>
                <button id="routeBtn">Route Wires</button>
                <p>You can download your DEF file here later: <span id="defDownloadLink"></span></p>
            </div>
        </div>

        <div class="right-panel">
            <div class="section">
                <h2>Design Visualization</h2>
                <div id="layout-viewer">
                    <canvas id="designCanvas" width="780" height="380" style="border:1px solid #000;"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>Terminal Output</h2>
                <div id="terminal-output-container">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>

    <script type="module">
        // Import the modern runYosys function from the YoWASP package [1]
        import { runYosys } from 'https://cdn.jsdelivr.net/npm/@yowasp/yosys/gen/bundle.js';

        // --- DOM Element References ---
        const terminalContainer = document.getElementById('terminal-output-container');
        const rtlFileInput = document.getElementById('rtlFileInput');
        const rtlCodeInput = document.getElementById('rtlCodeInput');
        const runSynthesisBtn = document.getElementById('runSynthesisBtn');
        const placeBtn = document.getElementById('placeBtn');
        const routeBtn = document.getElementById('routeBtn');
        const netlistDownloadLink = document.getElementById('netlistDownloadLink');
        const designCanvas = document.getElementById('designCanvas');
        const ctx = designCanvas.getContext('2d');

        // --- Global State Variables ---
        let currentNetlist = null;
        const allButtons = Array.from(document.querySelectorAll('button'));

        function setControlsEnabled(enabled) {
            allButtons.forEach(button => button.disabled =!enabled);
            rtlFileInput.disabled =!enabled;
            rtlCodeInput.disabled =!enabled;
        }

        // --- Terminal Setup (using xterm.js) ---
        const term = new Terminal({
            cursorBlink: true,
            convertEol: true,
            rows: 15
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(terminalContainer);
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        // Helper to write colored text to terminal for better feedback
        function termWriteError(text) {
            term.write(`\x1b;
            if (file) {
                const reader = new FileReader(); // [2, 3]
                reader.onload = (e) => {
                    rtlCodeInput.value = e.target.result;
                };
                reader.readAsText(file); // [4, 5]
            }
        });

        // --- Synthesis Button Handler (Updated with modern API) ---
        runSynthesisBtn.addEventListener('click', async () => {
            const verilogCode = rtlCodeInput.value;
            if (!verilogCode.trim()) {
                termWriteError('Error: Verilog code input is empty.\r\n');
                return;
            }

            setControlsEnabled(false);
            term.clear();
            term.write('--- Starting Full Synthesis Flow ---\r\n');
            currentNetlist = null;
            ctx.clearRect(0, 0, designCanvas.width, designCanvas.height);
            netlistDownloadLink.innerHTML = '';

            try {
                // 1. Fetch the Liberty library file from the GitHub repo you provided
                const libertyURL = 'https://raw.githubusercontent.com/Centre-for-Hardware-Security/asap7_reference_design/main/lib/asap7sc7p5t_24_R_TT_1p00V_25C.lib';
                term.write('1. Fetching technology library...\r\n');
                const response = await fetch(libertyURL);
                if (!response.ok) {
                    throw new Error(`HTTP error fetching library! status: ${response.status}`);
                }
                const libertyFileContent = await response.text();
                term.write('  ... Library fetched successfully.\r\n');

                // 2. Prepare files for the virtual filesystem [1]
                const filesIn = {
                    'design.v': verilogCode,
                    'asap7.lib': libertyFileContent
                };

                // 3. Define the Yosys command-line arguments
                const args = [
                    '-p',
                    'read_verilog design.v; hierarchy -check -top my_design; proc; opt; fsm; opt; memory; opt; techmap; opt; dfflibmap -liberty asap7.lib; abc -liberty asap7.lib; clean; write_json output.json'
                ];

                // 4. Setup stdout/stderr handlers to show all Yosys output in the terminal [1]
                const decoder = new TextDecoder();
                const options = {
                    stdout: (chunk) => {
                        if (chunk) term.write(decoder.decode(chunk));
                    },
                    stderr: (chunk) => {
                        if (chunk) term.write(decoder.decode(chunk));
                    }
                };

                // 5. Run Yosys inside a try...catch block to handle errors [1]
                term.write('2. Running Yosys Synthesis...\r\n');
                term.write('----------------------------------------\r\n');
                const filesOut = await runYosys(args, filesIn, options);
                term.write('\r\n----------------------------------------\r\n');

                // 6. Process the results if successful
                if (filesOut['output.json']) {
                    termWriteSuccess('Synthesis successful!\r\n');
                    const jsonContent = decoder.decode(filesOut['output.json']);
                    currentNetlist = JSON.parse(jsonContent);
                    term.write('  ... Parsed output netlist.\r\n');
                    createDownloadLink(jsonContent, 'netlist.json', 'application/json', netlistDownloadLink);
                    term.write('  ... Download link created.\r\n');
                } else {
                    throw new Error('Synthesis finished, but output.json was not found.');
                }

            } catch (error) {
                termWriteError(`\r\n--- SYNTHESIS FAILED ---\r\n`);
                termWriteError(error.message + '\r\n');
                // The detailed error from Yosys is already printed to the terminal by the stderr callback
            } finally {
                setControlsEnabled(true);
            }
        });

        // --- Placeholder button handlers for next steps ---
        placeBtn.addEventListener('click', () => {
            termWriteError('Placement functionality is not yet implemented.\r\n');
        });

        routeBtn.addEventListener('click', () => {
            termWriteError('Routing functionality is not yet implemented.\r\n');
        });

        // --- Helper Function ---
        function createDownloadLink(content, fileName, mimeType, linkElement) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.textContent = fileName;
            linkElement.innerHTML = '';
            linkElement.appendChild(a);
        }
    </script>
</body>
</html>
